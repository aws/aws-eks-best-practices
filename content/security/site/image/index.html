


<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      <link rel="shortcut icon" href="../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.1.2, mkdocs-material-5.5.7">
    
    
      
        <title>Image Security - EKS Best Practices Guides</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.b8ac9624.min.css">
      
      
    
    
    
      
        <link href="https://fonts.gstatic.com" rel="preconnect" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700%7CRoboto+Mono&display=fallback">
        <style>body,input{font-family:"Roboto",-apple-system,BlinkMacSystemFont,Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Roboto Mono",SFMono-Regular,Consolas,Menlo,monospace}</style>
      
    
    
    
    
      
    
    
  </head>
  
  
    <body dir="ltr">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#image-security" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
      <header class="md-header" data-md-component="header">
  <nav class="md-header-nav md-grid" aria-label="Header">
    <a href=".." title="EKS Best Practices Guides" class="md-header-nav__button md-logo" aria-label="EKS Best Practices Guides">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 003-3 3 3 0 00-3-3 3 3 0 00-3 3 3 3 0 003 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54z"/></svg>

    </a>
    <label class="md-header-nav__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2z"/></svg>
    </label>
    <div class="md-header-nav__title" data-md-component="header-title">
      
        <div class="md-header-nav__ellipsis">
          <span class="md-header-nav__topic md-ellipsis">
            EKS Best Practices Guides
          </span>
          <span class="md-header-nav__topic md-ellipsis">
            
              Image Security
            
          </span>
        </div>
      
    </div>
    
      <label class="md-header-nav__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0116 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 019.5 16 6.5 6.5 0 013 9.5 6.5 6.5 0 019.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
      </label>
      
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" data-md-state="active">
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0116 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 019.5 16 6.5 6.5 0 013 9.5 6.5 6.5 0 019.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
      </label>
      <button type="reset" class="md-search__icon md-icon" aria-label="Clear" data-md-component="search-reset" tabindex="-1">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z"/></svg>
      </button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header-nav__source">
        
<a href="https://github.com/aws/aws-eks-best-practices/" title="Go to repository" class="md-source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path d="M439.55 236.05L244 40.45a28.87 28.87 0 00-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 01-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 000 40.81l195.61 195.6a28.86 28.86 0 0040.8 0l194.69-194.69a28.86 28.86 0 000-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    aws/aws-eks-best-practices
  </div>
</a>
      </div>
    
  </nav>
</header>
    
    <div class="md-container" data-md-component="container">
      
        
      
      
        
          

  

<nav class="md-tabs md-tabs--active" aria-label="Tabs" data-md-component="tabs">
  <div class="md-tabs__inner md-grid">
    <ul class="md-tabs__list">
      
        
  
  
    <li class="md-tabs__item">
      
        <a href=".." class="md-tabs__link md-tabs__link--active">
          Security
        </a>
      
    </li>
  

      
        
  
  
    <li class="md-tabs__item">
      
        <a href="../cluster-autoscaling/" class="md-tabs__link">
          Cluster Autoscaling
        </a>
      
    </li>
  

      
    </ul>
  </div>
</nav>
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              <div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    <nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href=".." title="EKS Best Practices Guides" class="md-nav__button md-logo" aria-label="EKS Best Practices Guides">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 003-3 3 3 0 00-3-3 3 3 0 00-3 3 3 3 0 003 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54z"/></svg>

    </a>
    EKS Best Practices Guides
  </label>
  
    <div class="md-nav__source">
      
<a href="https://github.com/aws/aws-eks-best-practices/" title="Go to repository" class="md-source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path d="M439.55 236.05L244 40.45a28.87 28.87 0 00-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 01-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 000 40.81l195.61 195.6a28.86 28.86 0 0040.8 0l194.69-194.69a28.86 28.86 0 000-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    aws/aws-eks-best-practices
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  


  <li class="md-nav__item md-nav__item--active md-nav__item--nested">
    
      <input class="md-nav__toggle md-toggle" data-md-toggle="nav-1" type="checkbox" id="nav-1" checked>
    
    <label class="md-nav__link" for="nav-1">
      Security
      <span class="md-nav__icon md-icon">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M8.59 16.58L13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.42z"/></svg>
      </span>
    </label>
    <nav class="md-nav" aria-label="Security" data-md-level="1">
      <label class="md-nav__title" for="nav-1">
        <span class="md-nav__icon md-icon">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
        </span>
        Security
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href=".." title="Home" class="md-nav__link">
      Home
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../iam/" title="Identity and Access Management" class="md-nav__link">
      Identity and Access Management
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../pods/" title="Pod Security" class="md-nav__link">
      Pod Security
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../multitenancy/" title="Multi-tenancy" class="md-nav__link">
      Multi-tenancy
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../detective/" title="Detective Controls" class="md-nav__link">
      Detective Controls
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../network/" title="Network Security" class="md-nav__link">
      Network Security
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../data/" title="Data Encryption and Secrets Management" class="md-nav__link">
      Data Encryption and Secrets Management
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../runtime/" title="Runtime Security" class="md-nav__link">
      Runtime Security
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../hosts/" title="Infrastructure Security" class="md-nav__link">
      Infrastructure Security
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../compliance/" title="Regulatory Compliance" class="md-nav__link">
      Regulatory Compliance
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../incidents/" title="Incident Response and Forensics" class="md-nav__link">
      Incident Response and Forensics
    </a>
  </li>

        
          
          
          

  


  <li class="md-nav__item md-nav__item--active">
    
    <input class="md-nav__toggle md-toggle" data-md-toggle="toc" type="checkbox" id="__toc">
    
      
    
    
      <label class="md-nav__link md-nav__link--active" for="__toc">
        Image Security
        <span class="md-nav__icon md-icon">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 9h14V7H3v2m0 4h14v-2H3v2m0 4h14v-2H3v2m16 0h2v-2h-2v2m0-10v2h2V7h-2m0 6h2v-2h-2v2z"/></svg>
        </span>
      </label>
    
    <a href="./" title="Image Security" class="md-nav__link md-nav__link--active">
      Image Security
    </a>
    
      
<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
      </span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#recommendations" class="md-nav__link">
    Recommendations
  </a>
  
    <nav class="md-nav" aria-label="Recommendations">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#create-minimal-images" class="md-nav__link">
    Create minimal images
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#use-multi-stage-builds" class="md-nav__link">
    Use multi-stage builds
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#scan-images-for-vulnerabilities-regularly" class="md-nav__link">
    Scan images for vulnerabilities regularly
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#create-iam-policies-for-ecr-repositories" class="md-nav__link">
    Create IAM policies for ECR repositories
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#consider-using-ecr-private-endpoints" class="md-nav__link">
    Consider using ECR private endpoints
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#implement-endpoint-policies-for-ecr" class="md-nav__link">
    Implement endpoint policies for ECR
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#create-a-set-of-curated-images" class="md-nav__link">
    Create a set of curated images
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#add-the-user-directive-to-your-dockerfiles-to-run-as-a-non-root-user" class="md-nav__link">
    Add the USER directive to your Dockerfiles to run as a non-root user
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#lint-your-dockerfiles" class="md-nav__link">
    Lint your Dockerfiles
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#build-images-from-scratch" class="md-nav__link">
    Build images from Scratch
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#sign-your-images" class="md-nav__link">
    Sign your images
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#tools" class="md-nav__link">
    Tools
  </a>
  
</li>
      
    </ul>
  
</nav>
    
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-nav__toggle md-toggle" data-md-toggle="nav-2" type="checkbox" id="nav-2">
    
    <label class="md-nav__link" for="nav-2">
      Cluster Autoscaling
      <span class="md-nav__icon md-icon">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M8.59 16.58L13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.42z"/></svg>
      </span>
    </label>
    <nav class="md-nav" aria-label="Cluster Autoscaling" data-md-level="1">
      <label class="md-nav__title" for="nav-2">
        <span class="md-nav__icon md-icon">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
        </span>
        Cluster Autoscaling
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../cluster-autoscaling/" title="Home" class="md-nav__link">
      Home
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              <div class="md-sidebar md-sidebar--secondary" data-md-component="toc">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
      </span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#recommendations" class="md-nav__link">
    Recommendations
  </a>
  
    <nav class="md-nav" aria-label="Recommendations">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#create-minimal-images" class="md-nav__link">
    Create minimal images
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#use-multi-stage-builds" class="md-nav__link">
    Use multi-stage builds
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#scan-images-for-vulnerabilities-regularly" class="md-nav__link">
    Scan images for vulnerabilities regularly
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#create-iam-policies-for-ecr-repositories" class="md-nav__link">
    Create IAM policies for ECR repositories
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#consider-using-ecr-private-endpoints" class="md-nav__link">
    Consider using ECR private endpoints
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#implement-endpoint-policies-for-ecr" class="md-nav__link">
    Implement endpoint policies for ECR
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#create-a-set-of-curated-images" class="md-nav__link">
    Create a set of curated images
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#add-the-user-directive-to-your-dockerfiles-to-run-as-a-non-root-user" class="md-nav__link">
    Add the USER directive to your Dockerfiles to run as a non-root user
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#lint-your-dockerfiles" class="md-nav__link">
    Lint your Dockerfiles
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#build-images-from-scratch" class="md-nav__link">
    Build images from Scratch
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#sign-your-images" class="md-nav__link">
    Sign your images
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#tools" class="md-nav__link">
    Tools
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content">
            <article class="md-content__inner md-typeset">
              
                
                  <a href="https://github.com/aws/aws-eks-best-practices/edit/master/content/security/docs/image.md" title="Edit this page" class="md-content__button md-icon">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20.71 7.04c.39-.39.39-1.04 0-1.41l-2.34-2.34c-.37-.39-1.02-.39-1.41 0l-1.84 1.83 3.75 3.75M3 17.25V21h3.75L17.81 9.93l-3.75-3.75L3 17.25z"/></svg>
                  </a>
                
                
                  
                
                
                <h1 id="image-security">Image security<a class="headerlink" href="#image-security" title="Permanent link">&para;</a></h1>
<p>You should consider the container image as your first line of defense against an attack. An insecure, poorly constructed image can allow an attacker to escape the bounds of the container and gain access to the host.  Once on the host, an attacker can gain access to sensitive information or move laterally within the cluster or with your AWS account.  The following best practices will help mitigate risk of this happening. </p>
<h2 id="recommendations">Recommendations<a class="headerlink" href="#recommendations" title="Permanent link">&para;</a></h2>
<h3 id="create-minimal-images">Create minimal images<a class="headerlink" href="#create-minimal-images" title="Permanent link">&para;</a></h3>
<p>Start by removing all extraneous binaries from the container image.  If you’re using an unfamiliar image from Dockerhub, inspect the image using an application like <a href="https://github.com/wagoodman/dive">Dive</a> which can show you the contents of each of the container’s layers.  Remove all binaries with the SETUID and SETGID bits as they can be used to escalate privilege and consider removing all shells and utilities like nc and curl that can be used for nefarious purposes. You can find the files with SETUID and SETGID bits with the following command:</p>
<div class="codehilite"><pre><span></span><code>find / -perm /6000 -type f -exec ls -ld <span class="o">{}</span> <span class="se">\;</span>
</code></pre></div>


<p>To remove the special permissions from these files, add the following directive to your container image:</p>
<div class="codehilite"><pre><span></span><code><span class="k">RUN</span> find / -xdev -perm /6000 -type f -exec chmod a-s <span class="o">{}</span> <span class="se">\;</span> <span class="o">||</span> true
</code></pre></div>


<p>Colloquially, this is known as de-fanging your image. </p>
<h3 id="use-multi-stage-builds">Use multi-stage builds<a class="headerlink" href="#use-multi-stage-builds" title="Permanent link">&para;</a></h3>
<p>Using multi-stage builds is a way to create minimal images. Oftentimes, multi-stage builds are used to automate parts of the Continuous Integration cycle.  For example, multi-stage builds can be used to lint your source code or perform static code analysis.  This affords developers an opportunity to get near immediate feedback instead of waiting for a pipeline to execute.  Multi-stage builds are attractive from a security standpoint because they allow you to minimize the size of the final image pushed to your container registry.  Container images devoid of build tools and other extraneous binaries improves your security posture by reducing the attack surface of the image. For additional information about multi-stage builds, see <a href="https://docs.docker.com/develop/develop-images/multistage-build/">https://docs.docker.com/develop/develop-images/multistage-build/</a>.</p>
<h3 id="scan-images-for-vulnerabilities-regularly">Scan images for vulnerabilities regularly<a class="headerlink" href="#scan-images-for-vulnerabilities-regularly" title="Permanent link">&para;</a></h3>
<p>Like their virtual machine counterparts, container images can contain binaries and application libraries with vulnerabilities or develop vulnerabilities over time. The best way to safeguard against exploits is by regularly scanning your images with an image scanner.  Images that are stored in Amazon ECR can be scanned on push or on-demand (once during a 24 hour period). ECR currently leverages <a href="https://github.com/quay/clair">Clair</a> an open source image scanning solution.  After an image is scanned, the results are logged to the event stream for ECR in EventBridge. You can also see the results of a scan from within the ECR console.  Images with a HIGH or CRITICAL vulnerability should be deleted or rebuilt.  If an image that has been deployed develops a vulnerability, it should be replaced as soon as possible. </p>
<p>Knowing where images with vulnerabilities have been deployed is essential to keeping your environment secure.  While you could conceivably build an image tracking solution yourself, there are already several commercial offerings that provide this and other advanced capabilities out of the box, including:</p>
<ul>
<li><a href="https://docs.anchore.com/current/">Anchore</a></li>
<li><a href="https://www.twistlock.com/">Twistlock</a></li>
<li><a href="https://www.aquasec.com/">Aqua</a></li>
<li><a href="https://github.com/Portshift/kubei">Kubei</a></li>
<li><a href="https://github.com/aquasecurity/trivy">Trivy</a></li>
</ul>
<p>A Kubernetes validation webhook could also be used to validate that images are free of critical vulnerabilities.  Validation webhooks are invoked prior to the Kubernetes API.  They are typically used to reject requests that don't comply with the validation criteria defined in the webhook.  <a href="https://aws.amazon.com/blogs/containers/building-serverless-admission-webhooks-for-kubernetes-with-aws-sam/">This</a> is an example of a serverless webhook that calls the ECR describeImageScanFindings API to deteremine whether a pod is pulling an image with critical vulnerabilities.  If vulnerabilities are found, the pod is rejected and a message with list of CVEs is returned as an Event.</p>
<h3 id="create-iam-policies-for-ecr-repositories">Create IAM policies for ECR repositories<a class="headerlink" href="#create-iam-policies-for-ecr-repositories" title="Permanent link">&para;</a></h3>
<p>Nowadays, it is not uncommon for an organization to have multiple development teams operating independently within a shared AWS account.  If these teams don't need to share assets, you may want to create a set of IAM policies that restrict access to the repositories each team can interact with.  A good way to implement this is by using ECR <a href="https://docs.aws.amazon.com/AmazonECR/latest/userguide/Repositories.html#repository-concepts">namespaces</a>. Namespaces are a way to group similar repositories together.  For example, all of the registries for team A can be prefaced with the team-a/ while those for team B can use the team-b/ prefix. The policy to restrict access might look like the following: </p>
<div class="codehilite"><pre><span></span><code><span class="p">{</span>
<span class="nt">&quot;Version&quot;</span><span class="p">:</span> <span class="s2">&quot;2012-10-17&quot;</span><span class="p">,</span>
<span class="nt">&quot;Statement&quot;</span><span class="p">:</span> <span class="p">[{</span>
  <span class="nt">&quot;Sid&quot;</span><span class="p">:</span> <span class="s2">&quot;AllowPushPull&quot;</span><span class="p">,</span>
  <span class="nt">&quot;Effect&quot;</span><span class="p">:</span> <span class="s2">&quot;Allow&quot;</span><span class="p">,</span>
  <span class="nt">&quot;Principal&quot;</span><span class="p">:</span> <span class="p">{</span>
    <span class="nt">&quot;AWS&quot;</span><span class="p">:</span> <span class="s2">&quot;arn:aws:iam::123456789012:role/&lt;team_a_role_name&gt;&quot;</span>
  <span class="p">},</span>
  <span class="nt">&quot;Action&quot;</span><span class="p">:</span> <span class="p">[</span>
    <span class="s2">&quot;ecr:GetDownloadUrlForLayer&quot;</span><span class="p">,</span>
    <span class="s2">&quot;ecr:BatchGetImage&quot;</span><span class="p">,</span>
    <span class="s2">&quot;ecr:BatchCheckLayerAvailability&quot;</span><span class="p">,</span>
    <span class="s2">&quot;ecr:PutImage&quot;</span><span class="p">,</span>
    <span class="s2">&quot;ecr:InitiateLayerUpload&quot;</span><span class="p">,</span>
    <span class="s2">&quot;ecr:UploadLayerPart&quot;</span><span class="p">,</span>
    <span class="s2">&quot;ecr:CompleteLayerUpload&quot;</span>
  <span class="p">],</span>
  <span class="nt">&quot;Resource&quot;</span><span class="p">:</span> <span class="p">[</span>
    <span class="s2">&quot;arn:aws:ecr:region:123456789012:repository/team-a/*&quot;</span>
  <span class="p">]</span>
  <span class="p">}]</span>
<span class="p">}</span>
</code></pre></div>


<h3 id="consider-using-ecr-private-endpoints">Consider using ECR private endpoints<a class="headerlink" href="#consider-using-ecr-private-endpoints" title="Permanent link">&para;</a></h3>
<p>The ECR API has a public endpoint.  Consequently, ECR registries can be accessed from the Internet so long as the request has been authenticated and authorized by IAM. For those who need to operate in a sandboxed environment where the cluster VPC lacks an Internet Gateway (IGW), you can configure a private endpoint for ECR.  Creating a private endpoint enables you to privately access the ECR API through a private IP address instead of routing traffic across the Internet. For additional information on this topic, see https://docs.aws.amazon.com/AmazonECR/latest/userguide/vpc-endpoints.html.</p>
<h3 id="implement-endpoint-policies-for-ecr">Implement endpoint policies for ECR<a class="headerlink" href="#implement-endpoint-policies-for-ecr" title="Permanent link">&para;</a></h3>
<p>The default endpoint policy for allows access to all ECR repositories within a region.  This might allow an attacker/insider to exfiltrate data by packaging it as a container image and pushing it to a registry in another AWS account.  Mitigating this risk involves creating an endpoint policy that limits API access to ECR respositories. For example, the following policy allows all AWS principles in your account to perform all actions against your and only your ECR repositories: </p>
<div class="codehilite"><pre><span></span><code><span class="p">{</span>
    <span class="nt">&quot;Statement&quot;</span><span class="p">:</span> <span class="p">[{</span>
    <span class="nt">&quot;Sid&quot;</span><span class="p">:</span> <span class="s2">&quot;LimitECRAccess&quot;</span><span class="p">,</span>
    <span class="nt">&quot;Principal&quot;</span><span class="p">:</span> <span class="s2">&quot;*&quot;</span><span class="p">,</span>
    <span class="nt">&quot;Action&quot;</span><span class="p">:</span> <span class="s2">&quot;*&quot;</span><span class="p">,</span>
    <span class="nt">&quot;Effect&quot;</span><span class="p">:</span> <span class="s2">&quot;Allow&quot;</span><span class="p">,</span>
    <span class="nt">&quot;Resource&quot;</span><span class="p">:</span> <span class="s2">&quot;arn:aws:ecr:region:&lt;your_account_id&gt;:repository/*&quot;</span>
    <span class="p">},</span>
  <span class="p">]</span>
<span class="p">}</span>
</code></pre></div>


<p>You can enhance this further by setting a condition that uses the new <code>PrincipalOrgID</code> attribute which will prevent pushing/pulling of images by an IAM principle that is not part of your AWS Organization. See, <a href="https://docs.aws.amazon.com/IAM/latest/UserGuide/reference_policies_condition-keys.html#condition-keys-principalorgid">aws:PrincipalOrgID</a> for additional details. </p>
<p>We recommended applying the same policy to both the <code>com.amazonaws.&lt;region&gt;.ecr.dkr</code> and the <code>com.amazonaws.&lt;region&gt;.ecr.api</code> endpoints.</p>
<p>Since EKS pulls images for kube-proxy, coredns, and aws-node from ECR, you will need to add the account ID of the registry, e.g. <code>602401143452.dkr.ecr.us-west-2.amazonaws.com/*</code> to the list of resources in the endpoint policy or alter the policy to allow pulls from "*" and restrict pushes to your account ID.  The table below reveals the mapping between the AWS accounts where EKS images are vended from and cluster region.</p>
<table>
<thead>
<tr>
<th>Account Number</th>
<th>Region</th>
</tr>
</thead>
<tbody>
<tr>
<td>602401143452</td>
<td>All commercial regions except for those listed below</td>
</tr>
<tr>
<td>800184023465</td>
<td>HKG</td>
</tr>
<tr>
<td>558608220178</td>
<td>BAH</td>
</tr>
<tr>
<td>918309763551</td>
<td>BJS</td>
</tr>
<tr>
<td>961992271922</td>
<td>ZHY</td>
</tr>
</tbody>
</table>
<p>For further information about using endpoint policies, see <a href="https://aws.amazon.com/blogs/containers/using-vpc-endpoint-policies-to-control-amazon-ecr-access/">Using VPC endpoint policies to control Amazon ECR access</a>. </p>
<h3 id="create-a-set-of-curated-images">Create a set of curated images<a class="headerlink" href="#create-a-set-of-curated-images" title="Permanent link">&para;</a></h3>
<p>Rather than allowing developers to create their own images, consider creating a set of vetted images for the different application stacks in your organization.  By doing so, developers can forego learning how to compose Dockerfiles and concentrate on writing code.  As changes are merged into Master, a CI/CD pipeline can automatically compile the asset, store it in an artifact repository and copy the artifact into the appropriate image before pushing it to a Docker registry like ECR. At the very least you should create a set of base images from which developers to create their own Dockerfiles.  Ideally, you want to avoid pulling images from Dockerhub because a) you don't always know what is in the image and b) about <a href="https://www.kennasecurity.com/blog/one-fifth-of-the-most-used-docker-containers-have-at-least-one-critical-vulnerability/">a fifth</a> of the top 1000 images have vulnerabilties. A list of those images and their vulnerabilities can be found at https://vulnerablecontainers.org/.</p>
<h3 id="add-the-user-directive-to-your-dockerfiles-to-run-as-a-non-root-user">Add the USER directive to your Dockerfiles to run as a non-root user<a class="headerlink" href="#add-the-user-directive-to-your-dockerfiles-to-run-as-a-non-root-user" title="Permanent link">&para;</a></h3>
<p>As was mentioned in the pod security section, you should avoid running container as root.  While you can configure this as part of the podSpec, it is a good habit to use the <code>USER</code> directive to your Dockerfiles.  The <code>USER</code> directive sets the UID to use when running <code>RUN</code>, <code>ENTRYPOINT</code>, or <code>CMD</code> instruction that appears after the USER directive.</p>
<h3 id="lint-your-dockerfiles">Lint your Dockerfiles<a class="headerlink" href="#lint-your-dockerfiles" title="Permanent link">&para;</a></h3>
<p>Linting can be used to verify that your Dockerfiles are adhering to a set of predefined guidelines, e.g. the inclusion of the <code>USER</code> directive or the requirement that all images be tagged.  <a href="https://github.com/projectatomic/dockerfile_lint">dockerfile_lint</a> is an open source project from RedHat that verifies common best practices and includes a rule engine that you can use to build your own rules for linting Dockerfiles. It can be incorporated into a CI pipeline, in that builds with Dockerfiles that violate a rule will automatically fail. </p>
<h3 id="build-images-from-scratch">Build images from Scratch<a class="headerlink" href="#build-images-from-scratch" title="Permanent link">&para;</a></h3>
<p>Reducing the attack surface of your container images should be primary aim when building images.  The ideal way to do this is by creating minimal images that are devoid of binaries that can be used to exploit vulnerabilities. Fortunately, Docker has a mechanism to create images from <a href="https://docs.docker.com/develop/develop-images/baseimages/#create-a-simple-parent-image-using-scratch"><code>scratch</code></a>. With langages like Go, you can create a static linked binary and reference it in your Dockerfile as in this example: </p>
<div class="codehilite"><pre><span></span><code><span class="c">############################</span>
<span class="c"># STEP 1 build executable binary</span>
<span class="c">############################</span>
<span class="k">FROM</span> <span class="s">golang:alpine</span> <span class="k">AS</span> <span class="s">builder</span>
<span class="c"># Install git.</span>
<span class="c"># Git is required for fetching the dependencies.</span>
<span class="k">RUN</span> apk update <span class="o">&amp;&amp;</span> apk add --no-cache git
<span class="k">WORKDIR</span><span class="s"> $GOPATH/src/mypackage/myapp/</span>
<span class="k">COPY</span> . .
<span class="c"># Fetch dependencies.</span>
<span class="c"># Using go get.</span>
<span class="k">RUN</span> go get -d -v
<span class="c"># Build the binary.</span>
<span class="k">RUN</span> go build -o /go/bin/hello
<span class="c">############################</span>
<span class="c"># STEP 2 build a small image</span>
<span class="c">############################</span>
<span class="k">FROM</span> <span class="s">scratch</span>
<span class="c"># Copy our static executable.</span>
<span class="k">COPY</span> --from<span class="o">=</span>builder /go/bin/hello /go/bin/hello
<span class="c"># Run the hello binary.</span>
<span class="k">ENTRYPOINT</span> <span class="p">[</span><span class="s2">&quot;/go/bin/hello&quot;</span><span class="p">]</span>
</code></pre></div>


<p>This creates a container image that consists of your application and nothing else, making it extremely secure.</p>
<h3 id="sign-your-images">Sign your images<a class="headerlink" href="#sign-your-images" title="Permanent link">&para;</a></h3>
<p>When Docker was first introduced, there was no cryptographic model for verifying container images.  With v2, Docker added digests to the image manifest. This allowed an image’s configuration to be hashed and for the hash to be used to generate an ID for the image.  When image signing is enabled, the [Docker] engine verifies the manifest’s signature, ensuring that the content was produced from a trusted source and no tampering has occurred. After each layer is downloaded, the engine verifies the digest of the layer, ensuring that the content matches the content specified in the manifest.  Image signing  effectively allows you to create a secure supply chain, through the verification of digital signatures associated with the image. </p>
<p>In a Kubernetes environment, you can use an dynamic admission controller to verify that an image has been signed, as in these examples: https://github.com/IBM/portieris and https://github.com/kelseyhightower/grafeas-tutorial. By signing your images, you're verifying the publisher (source) ensuring that the image hasn't been tampered with (integrity).</p>
<h2 id="tools">Tools<a class="headerlink" href="#tools" title="Permanent link">&para;</a></h2>
<ul>
<li><a href="https://github.com/genuinetools/bane">Bane</a> An AppArmor profile generator for Docker containers</li>
<li><a href="https://github.com/docker-slim/docker-slim">docker-slim</a> Build secure minimal images</li>
<li><a href="https://github.com/projectatomic/dockerfile_lint">dockerfile-lint</a> Rule based linter for Dockerfiles</li>
<li><a href="https://github.com/open-policy-agent/gatekeeper">Gatekeeper and OPA</a> A policy based admission controller</li>
<li><a href="https://in-toto.io/">in-toto</a> Allows the user to verify if a step in the supply chain was intended to be performed, and if the step was performed by the right actor</li>
<li><a href="https://github.com/theupdateframework/notary">Notary</a> A project for signing container images</li>
<li><a href="https://grafeas.io/">Grafeas</a> An open artifact metadata API to audit and govern your software supply chain</li>
</ul>
                
              
              
                


              
            </article>
          </div>
        </div>
      </main>
      
        
<footer class="md-footer">
  
    <div class="md-footer-nav">
      <nav class="md-footer-nav__inner md-grid" aria-label="Footer">
        
          <a href="../incidents/" title="Incident Response and Forensics" class="md-footer-nav__link md-footer-nav__link--prev" rel="prev">
            <div class="md-footer-nav__button md-icon">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
            </div>
            <div class="md-footer-nav__title">
              <div class="md-ellipsis">
                <span class="md-footer-nav__direction">
                  Previous
                </span>
                Incident Response and Forensics
              </div>
            </div>
          </a>
        
        
          <a href="../cluster-autoscaling/" title="Home" class="md-footer-nav__link md-footer-nav__link--next" rel="next">
            <div class="md-footer-nav__title">
              <div class="md-ellipsis">
                <span class="md-footer-nav__direction">
                  Next
                </span>
                Home
              </div>
            </div>
            <div class="md-footer-nav__button md-icon">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4z"/></svg>
            </div>
          </a>
        
      </nav>
    </div>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
        Made with
        <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
          Material for MkDocs
        </a>
      </div>
      
    </div>
  </div>
</footer>
      
    </div>
    
      <script src="../assets/javascripts/vendor.d1f5a259.min.js"></script>
      <script src="../assets/javascripts/bundle.d5fec882.min.js"></script><script id="__lang" type="application/json">{"clipboard.copy": "Copy to clipboard", "clipboard.copied": "Copied to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.result.placeholder": "Type to start searching", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents"}</script>
      
      <script>
        app = initialize({
          base: "..",
          features: ["tabs"],
          search: Object.assign({
            worker: "../assets/javascripts/worker/search.fae956e7.min.js"
          }, typeof search !== "undefined" && search)
        })
      </script>
      
    
  </body>
</html>